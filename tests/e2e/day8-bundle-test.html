<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Day 8: AWS Crypto Bundle Test</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #1a1a1a; color: #00ff00; }
        .test-result { margin: 10px 0; padding: 10px; border: 1px solid #333; }
        .success { border-color: #00ff00; background: #001100; }
        .error { border-color: #ff0000; background: #110000; }
        .info { border-color: #0080ff; background: #000011; }
        pre { margin: 5px 0; }
    </style>
</head>
<body>
    <h1>Day 8: AWS Encryption SDK Bundle Test</h1>
    <p>Testing selective imports and bundle size verification</p>
    
    <div id="test-results"></div>
    
    <h2>Bundle Analysis</h2>
    <div id="bundle-analysis"></div>

    <!-- Include crypto logger first -->
    <script src="../utils/cryptoLogger.js"></script>
    
    <script type="module">
        const results = document.getElementById('test-results');
        const bundleAnalysis = document.getElementById('bundle-analysis');
        
        function addResult(type, title, content) {
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            div.innerHTML = `<strong>${title}</strong><pre>${content}</pre>`;
            results.appendChild(div);
        }

        function addBundleInfo(title, content) {
            const div = document.createElement('div');
            div.className = 'test-result info';
            div.innerHTML = `<strong>${title}</strong><pre>${content}</pre>`;
            bundleAnalysis.appendChild(div);
        }

        async function runBundleTests() {
            // Test 1: Check WebCrypto availability
            try {
                if (window.crypto && window.crypto.subtle) {
                    addResult('success', 'WebCrypto Check', 'WebCrypto API is available');
                } else {
                    addResult('error', 'WebCrypto Check', 'WebCrypto API is NOT available');
                    return;
                }
            } catch (error) {
                addResult('error', 'WebCrypto Check', `Error: ${error.message}`);
                return;
            }

            // Test 2: Test selective imports
            try {
                // Import AWS Crypto module
                const module = await import('../utils/awsCrypto.js');
                addResult('success', 'Selective Import Test', 'AWS Encryption SDK modules imported successfully');
                
                // Test initialization
                await window.awsCrypto.initialize();
                addResult('success', 'Initialization Test', 'AWS Crypto initialized successfully');
                
                // Get key info
                const keyInfo = await window.awsCrypto.getKeyInfo();
                addResult('success', 'Key Info Test', JSON.stringify(keyInfo, null, 2));
                
            } catch (error) {
                addResult('error', 'Import/Initialization Test', `Error: ${error.message}\nStack: ${error.stack}`);
                return;
            }

            // Test 3: Basic encryption/decryption cycle
            try {
                const testData = 'Hello, AWS Encryption SDK!';
                
                // Encrypt
                const encrypted = await window.awsCrypto.encrypt(testData, {
                    fileType: 'text/plain'
                });
                
                addResult('success', 'Encryption Test', 
                    `Original: ${testData.length} bytes\n` +
                    `Encrypted: ${encrypted.encryptedSize} bytes\n` +
                    `Algorithm: ${encrypted.algorithm}\n` +
                    `Processing time: ${encrypted.processingTime}ms`
                );
                
                // Decrypt
                const decrypted = await window.awsCrypto.decrypt(encrypted);
                const decryptedText = new TextDecoder().decode(decrypted.data);
                
                if (decryptedText === testData) {
                    addResult('success', 'Decryption Test', 
                        `Decryption successful\n` +
                        `Processing time: ${decrypted.processingTime}ms\n` +
                        `Data matches: ${decryptedText === testData}`
                    );
                } else {
                    addResult('error', 'Decryption Test', 
                        `Data mismatch:\nExpected: ${testData}\nGot: ${decryptedText}`
                    );
                }
                
            } catch (error) {
                addResult('error', 'Encryption/Decryption Test', `Error: ${error.message}\nStack: ${error.stack}`);
            }

            // Test 4: Bundle size analysis (approximation)
            try {
                // Estimate bundle size by checking script loading
                const scripts = document.querySelectorAll('script[src]');
                let totalSize = 0;
                
                for (const script of scripts) {
                    try {
                        const response = await fetch(script.src);
                        const size = (await response.blob()).size;
                        totalSize += size;
                        addBundleInfo(`Script: ${script.src.split('/').pop()}`, `${size} bytes (${(size/1024).toFixed(1)} KB)`);
                    } catch (e) {
                        addBundleInfo(`Script: ${script.src.split('/').pop()}`, 'Size unknown');
                    }
                }
                
                // Check if we're under the 500KB target
                const totalKB = totalSize / 1024;
                const targetKB = 500;
                const status = totalKB < targetKB ? 'success' : 'error';
                
                addResult(status, 'Bundle Size Analysis', 
                    `Total estimated size: ${totalKB.toFixed(1)} KB\n` +
                    `Target: <${targetKB} KB\n` +
                    `Status: ${totalKB < targetKB ? 'UNDER TARGET' : 'OVER TARGET'}\n\n` +
                    `Note: This is an approximation. Real bundle size would be measured with webpack/rollup.`
                );
                
            } catch (error) {
                addResult('error', 'Bundle Size Analysis', `Error: ${error.message}`);
            }

            // Test 5: Fail-closed behavior
            try {
                // Temporarily disable WebCrypto to test fail-closed
                const originalCrypto = window.crypto;
                delete window.crypto;
                
                try {
                    await window.awsCrypto.encrypt('test');
                    addResult('error', 'Fail-Closed Test', 'SECURITY ISSUE: Encryption succeeded without WebCrypto');
                } catch (error) {
                    addResult('success', 'Fail-Closed Test', `Correctly failed without WebCrypto: ${error.message}`);
                }
                
                // Restore WebCrypto
                window.crypto = originalCrypto;
                
            } catch (error) {
                addResult('error', 'Fail-Closed Test', `Test error: ${error.message}`);
            }

            addResult('info', 'Day 8 Validation Complete', 
                'All Day 8 tests completed. Check results above.\n' +
                'Next: Day 9 - Raw AES keyring setup + single-file encryption test'
            );
        }

        // Run tests when page loads
        runBundleTests();
    </script>
</body>
</html>
